# Feature Breadkown: v0.0.6 - **Ask AI Widget Feature**

## Goal
Create a ChatGPT-like interface with proper scrolling behavior, real-time messaging, and full GraphQL backend integration.

## Current Status 
- **Layout & Scrolling**: ChatGPT-like responsive layout with proper scroll behavior
- **GraphQL Integration**: Full Apollo Client v4 integration with backend
- **Real Conversations**: Connected to MongoDB with real conversation IDs
- **Message Management**: Send/receive messages with proper ordering (chronological)
- **Title Generation**: Automatic conversation titles generated by AI
- **Authentication**: JWT token-based authentication system
- **Cache Management**: Apollo Client cache policies for real-time updates

## Implementation Details

### Backend Integration:
1. **GraphQL Mutations**: `startConversation`, `sendMessage` connected to backend
2. **Real Conversation IDs**: Using MongoDB ObjectIds instead of synthetic IDs
3. **Message ordering**: Fixed reverse order issue - messages now display chronologically
4. **Title Generation**: Backend generates titles asynchronously, frontend refetches after 2s
5. **Cache Policies**: Added conversations cache policy to ensure title updates

### Key Layout Fixes Applied:
1. **Main Chat Area**: Added `min-h-0` to prevent flex item from growing beyond container
2. **Chat Header**: Added `flex-shrink-0` to prevent header from shrinking
3. **Messages Container**: Changed to `flex-1 min-h-0 overflow-hidden` for proper height constraint
4. **Chat Input**: Wrapped in `flex-shrink-0` container to keep it fixed at bottom
5. **ChatMessages Component**: Changed from `flex-1` to `h-full` for proper height inheritance
6. **Root Layout Fix**: Removed `py-8` padding from root layout that was causing page overflow with `h-screen`

### GraphQL Features:
- **Apollo Client v4**: HttpLink, ErrorLink, RetryLink, AuthLink configuration
- **Authentication Link**: JWT token handling from localStorage (to be replaced by NextAuth)
- **Error Handling**: Automatic logout on auth errors, retry logic for network failures
- **Cache Management**: InMemoryCache with type policies for conversations and messages
- **Real-time Updates**: Network-only refetch for title updates

### Message Flow:
1. **Start Conversation**: `startConversation(message)` → Creates conversation + AI response
2. **Get Real ID**: Frontend refetches conversations to get real MongoDB ObjectId
3. **Title Generation**: Backend generates title asynchronously (2-3 seconds)
4. **Title Update**: Frontend refetches with `fetchPolicy: 'network-only'` to bypass cache
5. **Message Order**: Messages reversed on frontend to display chronologically (oldest→newest)

### CSS Classes Used:
- `h-screen`: Full viewport height on main container
- `flex flex-col`: Vertical flex layout
- `min-h-0`: Allows flex items to shrink below content size
- `flex-1`: Takes available space
- `flex-shrink-0`: Prevents shrinking
- `overflow-hidden`: Prevents scrolling on container
- `overflow-y-auto`: Enables vertical scrolling on messages
- `h-full`: Full height inheritance for messages container

### Architecture Changes:
- **Root Layout**: Removed global `<main>` wrapper with padding to allow chat page full height
- **Individual Pages**: Added `<main className="mx-auto max-w-6xl px-4 py-8">` wrapper to dashboard, login, and register pages
- **Chat Page**: Uses full viewport height without any padding constraints
- **Hook Structure**: `useChat` combines conversations, messages, and actions
- **Real-time Refetch**: Automatic conversation refetch for title updates

### Result:
- Page doesn't scroll vertically
- Only the chat messages area scrolls
- ChatGPT-like fixed layout behavior
- Responsive on mobile and desktop
- Header and input remain fixed in position
- Real conversations with MongoDB ObjectIds
- AI-generated conversation titles
- Proper message chronological ordering
- Auto-scroll to latest messages

## Technical Stack
- **Frontend**: Next.js 15, TypeScript, Tailwind CSS, Radix UI
- **GraphQL**: Apollo Client v4 with full caching and error handling
- **Backend**: Node.js GraphQL server with MongoDB
- **Authentication**: JWT tokens with automatic refresh
- **State Management**: React hooks with Apollo Client cache

## Feature Breadkdown
- Integrate with backend OpenAI endpoints ✅
- Implement conversation persistence and history ✅
- Adjust chat title using MD format ✅
- Add typing indicators and message status ✅
- Add rate limiting UI feedback ✅
- Build floating chat widget with minimize/maximize
- Create conversation export functionality
- chat page "### Visitor Car Park Rules" not treated... ✅
- daily limit token usage needs to be added to interface just like we did for rate limit ✅
- break useChat into smaller hooks (useLimits.tsx) ✅
- make settings icon work at Excel Pilot User - Free Plan footer info (use user name too)
- add Atlas image somewhere (maybe replace "Bot" icon)

## Next Steps
- **Optimize cache invalidation strategies**
- **Add typing indicators and message status**
- **Add message reactions and threading**
- **Add file upload support**
- **Add conversation search and filtering**


